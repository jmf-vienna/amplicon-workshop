---
title: Using SummarizedExperiment (with JMF amplicon projects)
author: Bela Hausmann (Joint Microbiome Facility)
output: 
  html_document: 
    toc: true
    keep_md: true
---


```{r}
library(conflicted)
library(jmf)
quiet()
library(tidyverse)
```

* `mia` loads many functions that mask other packages:
  * To hide the warnings we use `suppressPackageStartupMessages`.
  * To avoid unpredictable results, we use `conflicted::conflicts_prefer` to choose which functions we actually want.
  * All function with duplicated names that are not specified with `conflicts_prefer(...)` will result in an error.

```{r}
suppressPackageStartupMessages(library(mia))
conflicts_prefer(dplyr::first, .quiet = TRUE)
```

For packages what will be cited in the paper's methods:

```{r}
packageVersion("mia")
citation("mia")
```


# Load

* Make liberal use of R's native pipe (`|>`).
* Instead of loading every package with `library(...)` we can also call it directly with `package::function`.
* `qs2` is a modern version of `rds` (`?readRDS`).

```{r}
se <-
  fs::dir_ls(glob = "*.qs2", recurse = TRUE) |>
  first() |>
  print() |>
  qs2::qs_read()
```


# Inspect

* `head(c(number_or_rows, number_of_cols))` keeps the example output small. **Do not use when further analyzing any of the output.**
* A `L` trailing a number specified the number is an integer.

```{r}
se

# raw counts
assay(se) |> head(c(5L, 3L))

# relative abundance (%)
(assay(se, "relabundance") * 100.0) |> head(c(5L, 3L))

# center log-ratios
assay(se, "clr") |> head(c(5L, 3L))
metadata(se)[["clr_pseudocount"]]
```

## Samples: BioSample/Library metadata

```{r}
colData(se) |> head(c(5L, 3L))
```

## Features: ASV/taxa taxonomy and metadata

```{r}
# standardized ranks
taxonomyRanks(se)
# JMF-style ranks
metadata(se)[["taxonomy_ranks"]][["current"]]

rowData(se) |> head(c(5L, 3L))
```

## more metadata

* `?str` keeps the example output small. **Do not use when further analyzing any of the output.**

```{r}
# Bioconductor-style metadata (generated by the JMF)
metadata(se) |> str()

# provenance metadata generated by the JMF
se |>
  attr("provenance", exact = TRUE) |>
  str()
```


# Further reading:

* https://microbiome.github.io/OMA/
