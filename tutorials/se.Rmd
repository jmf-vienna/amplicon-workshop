---
title: Using SummarizedExperiment (with JMF amplicon projects)
author: Bela Hausmann (Joint Microbiome Facility)
output: 
  html_document: 
    toc: true
    keep_md: true
---


```{r}
options(width = 120L)
```

```{r}
library(conflicted)
library(jmf)
quiet()
library(tidyverse)
```

* `mia` loads many functions that mask other packages:
  * To hide the warnings we use `suppressPackageStartupMessages`.
  * To avoid unpredictable results, we use `conflicted::conflicts_prefer` to choose which functions we actually want.
  * All function with duplicated names that are not specified with `conflicts_prefer(...)` will result in an error.

```{r}
suppressPackageStartupMessages(library(mia))
conflicts_prefer(dplyr::filter, .quiet = TRUE)
conflicts_prefer(dplyr::first, .quiet = TRUE)
```

For packages what will be cited in the paper's methods:

```{r}
packageVersion("mia")
citation("mia")
```


# Load

* Make liberal use of R's native pipe (`|>`).
* Instead of loading every package with `library(...)` we can also call it directly with `package::function`.
* `qs2` is a modern version of `rds` (`?readRDS`).

```{r}
se <-
  fs::dir_ls(glob = "*.qs2", recurse = TRUE) |>
  first() |>
  print() |>
  qs2::qs_read()
```


# Inspect

* `head(c(number_or_rows, number_of_cols))` keeps the example output small. **Do not use when further analyzing any of the output.**
* A `L` trailing a number specified the number is an integer.

```{r}
se

assayNames(se)

# raw counts
assay(se) |> head(c(5L, 3L))

# relative abundance (%)
(assay(se, "relabundance") * 100.0) |> head(c(5L, 3L))

# center log-ratios
assay(se, "clr") |> head(c(5L, 3L))
metadata(se)[["clr_pseudocount"]]
```

## Samples: BioSample/Library metadata

Columns are always samples (biosamples, libraries, merged meta-samples, etc).

```{r}
colData(se) |> head(c(5L, 3L))

# sample metadata variable names:
se |>
  colData() |>
  names() |>
  cat(sep = "\n")

# access single variables
head(se$Group)
# the more formal way:
colData(se)[, "Group"] |> head()
```

## Features: ASV/taxa taxonomy and metadata

Rows are always features, i.e., ASVs, OTUs, genera, etc.

```{r}
# standardized ranks
taxonomyRanks(se)
# JMF-style ranks
metadata(se)[["taxonomy_ranks"]][["current"]]

rowData(se) |> head(c(5L, 3L))

# Bioconductor/tidyverse mixed usage:
se |>
  rowData() |>
  as_tibble() |>
  select(Domain:ASV_ID) |>
  head()
```

## everything

```{r}
mse <-
  se |>
  meltSE(assay.type = "relabundance", add.row = TRUE, add.col = TRUE) |>
  mutate(relabundance := relabundance * 100)

dim(mse)
```

```{r}
# Arbitrary example:
mse |>
  filter(Family == "Nitrososphaeraceae") |>
  group_by(across(c(User_sample_ID, Group, Family:Genus))) |>
  summarise(relabundance = mean(relabundance), .groups = "drop") |>
  arrange(-relabundance) |>
  head(4)
```



## more metadata

* `?str` keeps the example output small. **Do not use when further analyzing any of the output.**

```{r}
# Bioconductor-style metadata (generated by the JMF)
metadata(se) |> str()

# provenance metadata generated by the JMF
se |>
  attr("provenance") |>
  str()
```

* JMF workflow functions can also be quickly (re-)used like this for convenience:

```{r}
source("https://raw.githubusercontent.com/jmf-vienna/amplicon-analysis/refs/heads/main/R/provenance.R")

se |>
  get_provenance() |>
  str()
provenance_as_short_title(se)
provenance_as_tibble(se)
```

## final tips

```{r}
# number of features:
nrow(se)

# number of samples:
ncol(se)

# internal feature IDs
rownames(se) |> head()

# internal sample IDs
colnames(se) |> head()
```



# Further reading:

* https://microbiome.github.io/OMA/
